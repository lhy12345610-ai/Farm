<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆíŠ¸ ë†ì¥ ê´€ë¦¬ PRO (ë°±ì‹ ì•Œë¦¼)</title>
    <style>
        :root { --main-pink: #ffafbd; --bg: #f8f9fa; --building-bg: #ffffff; --green: #2e7d32; --red: #c62828; --vaccine: #ff9800; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 80px; }
        h1 { font-size: 1.2rem; text-align: center; color: #333; margin-bottom: 20px; }

        .farm-map { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .map-building { 
            background: var(--building-bg); border: 2px solid #ddd; border-radius: 12px; padding: 12px;
            text-align: center; cursor: pointer; min-height: 70px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .map-building b { font-size: 0.9rem; margin-bottom: 4px; }
        .map-building span { font-size: 0.75rem; color: var(--green); font-weight: bold; }

        #detail-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; overflow-y: auto; padding: 20px 10px; box-sizing: border-box; }
        .nav-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .close-btn { flex: 1; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; font-size: 0.9rem; }

        .grid-container { display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); }
        .room-title { background: #f0f0f0; padding: 8px; font-size: 0.85rem; font-weight: bold; margin-top: 10px; border-radius: 5px; grid-column: 1 / -1; }
        
        .cell { 
            aspect-ratio: 1/1.1; border: 1.5px solid #eee; border-radius: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff;
            position: relative;
        }
        .cell span { font-size: 0.65rem; color: #888; }
        .cell b { font-size: 1.1rem; }
        .cell .date-info { font-size: 0.55rem; color: #555; text-align: center; margin-top: 2px; }
        
        /* ë°±ì‹  ì•Œë¦¼ ë±ƒì§€ */
        .vaccine-alert::after {
            content: "ğŸ’‰ë°±ì‹ "; position: absolute; top: -5px; right: -5px;
            background: var(--vaccine); color: white; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; font-weight: bold;
        }

        #action-modal { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 200; padding: 20px; box-sizing: border-box; }
        .btn-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .btn { padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 0.9rem; color: white; }
        .btn-in { background: var(--green); }
        .btn-out { background: var(--red); }
        .btn-date { background: #673ab7; grid-column: span 2; }

        .active { background: #e8f5e9; border-color: #a5d6a7; color: #2e7d32; }
        .full { background: #ffebee; border-color: #ef9a9a; color: #c62828; }
        .needs-vaccine { border: 2px solid var(--vaccine) !important; background: #fff3e0; }
    </style>
</head>
<body>

<h1>ğŸ· ë†ì¥ í†µí•© ê´€ë¦¬ (ë°±ì‹ /ì¼ì •)</h1>

<div class="farm-map" id="top-line"></div>
<div class="farm-map" id="bottom-line" style="grid-template-columns: repeat(2, 1fr);"></div>

<div id="detail-view">
    <div class="nav-bar"><button class="close-btn" onclick="closeBuilding()">â† ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button></div>
    <h2 id="detail-title" style="text-align:center; margin:10px 0;"></h2>
    <div id="detail-grid" class="grid-container"></div>
</div>

<div id="action-modal">
    <h3 id="modal-title" style="margin:0;">ì¹¸ ê´€ë¦¬</h3>
    <div id="modal-sub-info" style="font-size: 0.8rem; margin-bottom: 10px; color: #666;"></div>
    <div class="btn-group">
        <button class="btn btn-in" onclick="adjustCount(1)">+1 ì…ì‹</button>
        <button class="btn btn-out" onclick="adjustCount(-1)">-1 ì‚¬ê³ /íì‚¬</button>
        <button class="btn btn-date" id="date-btn" onclick="setInDate()">ì…ì‹ ë‚ ì§œ ì„¤ì •</button>
        <button class="btn" style="background:#1976d2; grid-column: span 2;" onclick="manualEdit()">ì§ì ‘ ìˆ˜ì •</button>
        <button class="btn" style="background:#888; grid-column: span 2;" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const buildings = {
        'farrow1': { title: 'ë¶„ë§Œ 1ë™', count: 8, line: 'top' },
        'farrow2': { title: 'ë¶„ë§Œ 2,3ë™', count: 12, line: 'top' },
        'nursery': { title: 'ìëˆì‚¬', rooms: 5, perRoom: 4, line: 'top', layout: 'room', alertVaccine: true },
        'grower': { title: 'ìœ¡ì„±ì‚¬', rooms: 6, perRoom: 6, line: 'top', layout: 'room' },
        'gilt': { title: 'í›„ë³´ì‚¬', count: 10, line: 'top' },
        'mating': { title: 'ì¢…ë¶€ì‚¬', count: 10, line: 'top' },
        'finisher1': { title: 'ë¹„ìœ¡ 1ë™', count: 12, line: 'bottom', layout: 'lr' },
        'finisher2': { title: 'ë¹„ìœ¡ 2ë™', count: 22, line: 'bottom', layout: 'lr' },
        'finisher3': { title: 'ë¹„ìœ¡ 3ë™', count: 21, line: 'bottom' },
        'gest4': { title: 'ì„ì‹  4ë™', count: 20, line: 'bottom' },
        'gest5': { title: 'ì„ì‹  5ë™', count: 20, line: 'bottom' }
    };

    let currentSelectedKey = '';
    const today = new Date();

    function initMap() {
        const top = document.getElementById('top-line');
        const bottom = document.getElementById('bottom-line');
        top.innerHTML = ''; bottom.innerHTML = '';
        for (let id in buildings) {
            const b = buildings[id];
            const div = document.createElement('div');
            div.className = 'map-building';
            div.onclick = () => openBuilding(id);
            let total = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(id) && !key.includes('_date')) {
                    total += parseInt(localStorage.getItem(key)) || 0;
                }
            }
            div.innerHTML = `<b>${b.title}</b><span>${total}ë‘</span>`;
            (b.line === 'top' ? top : bottom).appendChild(div);
        }
    }

    function openBuilding(id) {
        const b = buildings[id];
        const grid = document.getElementById('detail-grid');
        document.getElementById('detail-title').innerText = b.title;
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = b.layout === 'lr' ? 'repeat(2, 1fr)' : 'repeat(auto-fill, minmax(85px, 1fr))';

        if (b.layout === 'room') {
            for (let r = 1; r <= b.rooms; r++) {
                const rt = document.createElement('div'); rt.className = 'room-title'; rt.innerText = `${r}ë²ˆ ë°©`;
                grid.appendChild(rt);
                for (let c = 1; c <= b.perRoom; c++) createCell(grid, `${id}_${r}_${c}`, `${c}ë²ˆ`, b.alertVaccine);
            }
        } else {
            for (let i = 1; i <= b.count; i++) {
                let label = b.layout === 'lr' ? (i%2==1?'ì¢Œ':'ìš°')+Math.ceil(i/2) : i+'ë²ˆ';
                createCell(grid, `${id}_${i}`, label);
            }
        }
        document.getElementById('detail-view').style.display = 'block';
    }

    function createCell(parent, key, label, vaccineCheck) {
        const val = parseInt(localStorage.getItem(key)) || 0;
        const inDateStr = localStorage.getItem(key + '_date');
        const div = document.createElement('div');
        div.className = 'cell ' + (val == 0 ? '' : (val > 25 ? 'full' : 'active'));
        
        let dateHtml = '';
        if (inDateStr) {
            const inDate = new Date(inDateStr);
            const moveDate = new Date(inDate); moveDate.setDate(inDate.getDate() + 33);
            const vaccineDate = new Date(inDate); vaccineDate.setDate(inDate.getDate() + 23); // 33ì¼ ì „ 10ì¼ = 23ì¼ í›„
            
            dateHtml = `<div class="date-info">ì´ë™:${moveDate.getMonth()+1}/${moveDate.getDate()}</div>`;
            
            // ì˜¤ëŠ˜ì´ ë°±ì‹  ì˜ˆì •ì¼ ì „í›„ 2ì¼ ì‚¬ì´ë©´ ì•Œë¦¼
            const diffDays = Math.ceil((vaccineDate - today) / (1000 * 60 * 60 * 24));
            if (vaccineCheck && val > 0 && diffDays <= 3 && diffDays >= -1) {
                div.classList.add('needs-vaccine', 'vaccine-alert');
            }
        }

        div.innerHTML = `<span>${label}</span><b>${val}</b>${dateHtml}`;
        div.onclick = () => openModal(key, label, val, inDateStr);
        parent.appendChild(div);
    }

    function openModal(key, label, count, inDateStr) {
        currentSelectedKey = key;
        document.getElementById('modal-title').innerText = label + " ê´€ë¦¬";
        let info = `í˜„ì¬: ${count}ë‘`;
        if (inDateStr) {
            const inDate = new Date(inDateStr);
            const moveDate = new Date(inDate); moveDate.setDate(inDate.getDate() + 33);
            const vacDate = new Date(inDate); vacDate.setDate(inDate.getDate() + 23);
            info += `<br>ì…ì‹: ${inDateStr}<br><b>ë°±ì‹ ì ‘ì¢…ì¼: ${vacDate.getFullYear()}-${vacDate.getMonth()+1}-${vacDate.getDate()}</b><br>ì´ë™ì˜ˆì •: ${moveDate.getFullYear()}-${moveDate.getMonth()+1}-${moveDate.getDate()}`;
        }
        document.getElementById('modal-sub-info').innerHTML = info;
        document.getElementById('action-modal').style.display = 'block';
    }

    function setInDate() {
        const d = prompt("ì…ì‹ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
        if (d) {
            localStorage.setItem(currentSelectedKey + '_date', d);
            refreshUI();
        }
    }

    function adjustCount(amt) {
        let count = parseInt(localStorage.getItem(currentSelectedKey)) || 0;
        localStorage.setItem(currentSelectedKey, Math.max(0, count + amt));
        refreshUI();
    }

    function manualEdit() {
        const n = prompt("ë§ˆë¦¿ìˆ˜ ìˆ˜ì •:", localStorage.getItem(currentSelectedKey) || 0);
        if (n !== null) { localStorage.setItem(currentSelectedKey, n); refreshUI(); }
    }

    function refreshUI() { openBuilding(currentSelectedKey.split('_')[0]); closeModal(); initMap(); }
    function closeModal() { document.getElementById('action-modal').style.display = 'none'; }
    function closeBuilding() { document.getElementById('detail-view').style.display = 'none'; initMap(); }

    initMap();
</script>
</body>
</html>
