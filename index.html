<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë†ì¥ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        :root { --main-pink: #ffafbd; --bg: #f8f9fa; --building-bg: #ffffff; --green: #2e7d32; --red: #c62828; --vaccine: #ff9800; --work: #673ab7; --blue: #1976d2; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 80px; }
        h1 { font-size: 1.2rem; text-align: center; color: #333; margin-bottom: 20px; }

        .farm-map { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .map-building { 
            background: var(--building-bg); border: 2px solid #ddd; border-radius: 12px; padding: 12px;
            text-align: center; cursor: pointer; min-height: 70px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative;
        }
        .work-badge { position: absolute; top: -5px; right: -5px; background: var(--work); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-weight: bold; }
        .map-building b { font-size: 0.85rem; margin-bottom: 4px; }
        .map-building span { font-size: 0.75rem; color: var(--green); font-weight: bold; }

        #detail-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; overflow-y: auto; padding: 20px 10px; box-sizing: border-box; }
        .nav-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .close-btn { flex: 1; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; font-size: 0.9rem; }

        .grid-container { display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); }
        
        .room-header { background: #f0f0f0; padding: 12px; margin-top: 15px; border-radius: 10px; grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .room-header.this-week { border-left-color: var(--work); background: #f3e5f5; }
        .room-title-area { display: flex; flex-direction: column; flex: 1; }
        .room-title { font-size: 0.9rem; font-weight: bold; margin-bottom: 2px; }
        .room-total-input { background: var(--blue); color: white; border: none; border-radius: 6px; padding: 8px 12px; font-weight: bold; font-size: 0.85rem; cursor: pointer; text-align: center; min-width: 80px; }
        
        .cell { aspect-ratio: 1/1.1; border: 1.5px solid #eee; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; position: relative; }
        .cell b { font-size: 1.1rem; }
        .date-info { font-size: 0.55rem; color: #555; text-align: center; margin-top: 2px; }
        
        .vaccine-alert::after { content: attr(data-vaccine); position: absolute; top: -5px; right: -5px; background: var(--vaccine); color: white; font-size: 0.55rem; padding: 2px 4px; border-radius: 4px; font-weight: bold; }

        .entrance-bar { grid-column: 1 / -1; background: #444; color: white; text-align: center; padding: 8px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; }
        .gest-column { display: flex; flex-direction: column; gap: 10px; background: #f1f3f5; padding: 10px; border-radius: 10px; }
        .group-card { background: white; padding: 10px; border-radius: 8px; border-left: 5px solid var(--work); box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0.8rem; cursor: pointer; position: relative; }
        .group-card:active { background: #eee; }

        .gilt-group-pen { grid-column: 1 / -1; background: #e8f5e9; border: 2px dashed var(--green); border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: center; cursor: pointer; }
        
        #action-modal { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 200; padding: 25px 20px; box-sizing: border-box; }
        .btn-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; color: white; cursor: pointer; }
    </style>
</head>
<body>

<h1>ğŸ· ë†ì¥ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>

<div class="farm-map" id="top-line"></div>
<div class="farm-map" id="bottom-line" style="grid-template-columns: repeat(2, 1fr);"></div>

<div id="detail-view">
    <div class="nav-bar"><button class="close-btn" onclick="closeBuilding()">â† ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button></div>
    <h2 id="detail-title" style="text-align:center; margin:10px 0;"></h2>
    <div id="detail-grid" class="grid-container"></div>
</div>

<div id="action-modal">
    <h3 id="modal-title" style="margin:0;">ì¹¸ ê´€ë¦¬</h3>
    <div id="modal-sub-info" style="font-size: 0.9rem; margin: 10px 0; color: #444; background: #f8f9fa; padding: 10px; border-radius: 8px;"></div>
    <div class="btn-group" id="modal-buttons">
        </div>
</div>

<script>
    const buildings = {
        'farrow1': { title: 'ë¶„ë§Œ 1ë™', count: 8, line: 'top', cycle: 28, workDay: 5, workName: 'ê¸ˆìš”ì´ìœ ' },
        'farrow2': { title: 'ë¶„ë§Œ 2,3ë™', count: 12, line: 'top', cycle: 28, workDay: 5, workName: 'ê¸ˆìš”ì´ìœ ' },
        'nursery': { title: 'ìëˆì‚¬', rooms: 5, perRoom: 4, line: 'top', layout: 'room', cycle: 33, workDay: 2, workName: 'í™”/ìˆ˜ì „ì¶œ', vaccineDay: 23 },
        'grower': { title: 'ìœ¡ì„±ì‚¬', rooms: 6, perRoom: 3, line: 'top', layout: 'room', cycle: 28, workDay: 2, workName: 'í™”/ìˆ˜ì „ì¶œ', isGrower: true },
        'gilt': { title: 'í›„ë³´ì‚¬', count: 46, line: 'top', layout: 'giltSpecial' },
        'mating': { title: 'ì¢…ë¶€ì‚¬', count: 10, line: 'top' },
        'finisher1': { title: 'ë¹„ìœ¡ 1ë™', count: 12, line: 'bottom', layout: 'lr' },
        'finisher2': { title: 'ë¹„ìœ¡ 2ë™', count: 22, line: 'bottom', layout: 'lr' },
        'finisher3': { title: 'ë¹„ìœ¡ 3ë™', count: 21, line: 'bottom' },
        'gest4': { title: 'ì„ì‹  4ë™', line: 'bottom', layout: 'gestSpecial', rows: [82, 82], cycle: 114, isGest: true },
        'gest5': { title: 'ì„ì‹  5ë™', line: 'bottom', layout: 'gestSpecial', rows: [83, 83, 84], cycle: 114, isGest: true }
    };

    let currentSelectedKey = '';
    const today = new Date();
    const currentMonday = new Date(today);
    currentMonday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
    currentMonday.setHours(0,0,0,0);
    const currentSunday = new Date(currentMonday);
    currentSunday.setDate(currentMonday.getDate() + 6);

    function getGroupName(dateStr) {
        const d = new Date(dateStr);
        const day = d.getDay(); 
        const sunday = new Date(d);
        sunday.setDate(d.getDate() - day);
        return `${sunday.getMonth() + 1}ì›” ${sunday.getDate()}ì¼ ê·¸ë£¹`;
    }

    function checkWorkThisWeek(inDateStr, cycle) {
        if (!inDateStr) return false;
        const targetDate = new Date(inDateStr);
        targetDate.setDate(targetDate.getDate() + cycle);
        return targetDate >= currentMonday && targetDate <= currentSunday;
    }

    function initMap() {
        const top = document.getElementById('top-line');
        const bottom = document.getElementById('bottom-line');
        top.innerHTML = ''; bottom.innerHTML = '';
        for (let id in buildings) {
            const b = buildings[id];
            const div = document.createElement('div');
            div.className = 'map-building';
            div.onclick = () => openBuilding(id);
            let total = 0;
            let hasWork = false;

            if (b.layout === 'gestSpecial') {
                for(let r=1; r<=b.rows.length; r++){
                    const groups = JSON.parse(localStorage.getItem(`${id}_row${r}_groups`) || "[]");
                    groups.forEach(g => { 
                        total += (parseInt(g.count) || 0);
                        if(checkWorkThisWeek(g.date, b.cycle)) hasWork = true; 
                    });
                }
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(id) && !key.includes('_date') && !key.includes('_vaccine') && !key.includes('_row') && !key.includes('_group')) {
                        const val = parseInt(localStorage.getItem(key)) || 0;
                        if (val > 0) {
                            total += val;
                            const d = localStorage.getItem(key + '_date');
                            if (b.cycle && checkWorkThisWeek(d, b.cycle)) hasWork = true;
                            if (b.isGrower && (checkWorkThisWeek(d, 7) || checkWorkThisWeek(d, b.cycle - 7))) hasWork = true;
                        }
                    }
                }
                if(id === 'gilt') total = parseInt(localStorage.getItem('gilt_group_count')) || 0;
            }
            div.innerHTML = `${hasWork ? '<div class="work-badge">!</div>' : ''}<b>${b.title}</b><span>${total}ë‘</span>`;
            (b.line === 'top' ? top : bottom).appendChild(div);
        }
    }

    function openBuilding(id) {
        const b = buildings[id];
        const grid = document.getElementById('detail-grid');
        document.getElementById('detail-title').innerText = b.title;
        grid.innerHTML = '';

        if (b.layout === 'gestSpecial') {
            grid.style.gridTemplateColumns = `repeat(${b.rows.length}, 1fr)`;
            grid.innerHTML = `<div class="entrance-bar">â–¼ ê±´ë¬¼ ì…êµ¬ (1ë²ˆ ìŠ¤í†¨ ì‹œì‘) â–¼</div>`;
            b.rows.forEach((maxStall, idx) => {
                const rowNum = idx + 1;
                const col = document.createElement('div');
                col.className = 'gest-column';
                col.innerHTML = `<div style="text-align:center; font-weight:bold; font-size:0.8rem; margin-bottom:5px;">${rowNum}ì—´ (1~${maxStall})</div>
                                 <button class="room-total-input" style="width:100%; margin-bottom:10px;" onclick="setStallRange('${id}', ${rowNum}, ${maxStall})">ë²”ìœ„ ì¶”ê°€</button>`;
                const groups = JSON.parse(localStorage.getItem(`${id}_row${rowNum}_groups`) || "[]");
                groups.sort((a,b) => a.start - b.start).forEach((g, gIdx) => {
                    const fDate = new Date(g.date); fDate.setDate(fDate.getDate() + 114);
                    const card = document.createElement('div');
                    card.className = 'group-card';
                    if(checkWorkThisWeek(g.date, 114)) card.style.backgroundColor = "#fff3e0";
                    card.innerHTML = `<b>${g.start}~${g.end}ë²ˆ (${g.count || 0}ë‘)</b><br>
                                      <span style="color:var(--work)">${g.name}</span><br>
                                      <small>ë¶„ë§Œì˜ˆì •: ${fDate.getMonth()+1}/${fDate.getDate()}</small>`;
                    card.onclick = (e) => { e.stopPropagation(); openGestModal(id, rowNum, gIdx); };
                    col.appendChild(card);
                });
                grid.appendChild(col);
            });
        } else if (b.layout === 'giltSpecial') {
            grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            const gCount = localStorage.getItem(`${id}_group_count`) || 0;
            const gDate = localStorage.getItem(`${id}_group_date`) || '-';
            const gVaccine = localStorage.getItem(`${id}_group_vaccine`) || 'ì—†ìŒ';
            const groupPen = document.createElement('div');
            groupPen.className = 'gilt-group-pen';
            groupPen.innerHTML = `<h3>ğŸ‘‘ í›„ë³´ì‚¬ êµ°ì‚¬ì¹¸</h3><p><b>ì…ì‹ì¼ì:</b> ${gDate}</p><p><b>ë§ˆë¦¿ìˆ˜:</b> ${gCount}ë‘</p><p><b>ë°±ì‹ ì¢…ë¥˜:</b> ${gVaccine}</p>`;
            groupPen.onclick = () => editGiltGroup(id);
            grid.appendChild(groupPen);
            for (let i = 1; i <= b.count; i++) {
                const label = (i % 2 === 1 ? 'ì¢Œ' : 'ìš°') + Math.ceil(i / 2);
                createCell(grid, `${id}_${i}`, label, null, null);
            }
        } else if (b.layout === 'room') {
            grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(85px, 1fr))";
            for (let r = 1; r <= b.rooms; r++) {
                let roomTotal = 0, roomDates = [], roomHasWork = false, workType = "";
                for(let c=1; c<=b.perRoom; c++) {
                    const count = parseInt(localStorage.getItem(`${id}_${r}_${c}`)) || 0;
                    const d = localStorage.getItem(`${id}_${r}_${c}_date`);
                    if (count > 0) {
                        roomTotal += count;
                        if(d) {
                            roomDates.push(d);
                            if(checkWorkThisWeek(d, b.cycle)) { roomHasWork = true; workType = b.workName; }
                            if(b.isGrower) {
                                if(checkWorkThisWeek(d, 7)) { roomHasWork = true; workType = "í‰ë§‰ë°±ì‹ "; }
                                if(checkWorkThisWeek(d, b.cycle - 7)) { roomHasWork = true; workType = "êµ¬ì œì—­"; }
                            }
                        }
                    }
                }
                const header = document.createElement('div');
                header.className = 'room-header' + (roomHasWork ? ' this-week' : '');
                header.innerHTML = `<div class="room-title-area"><div class="room-title">${r}ë²ˆ ë°© ${roomHasWork ? '['+workType+']' : ''}</div><div style="font-size:0.65rem; color:#666;">ì…ì‹: ${[...new Set(roomDates)].join(', ') || 'ì—†ìŒ'}</div></div><button class="room-total-input" onclick="batchSetRoom('${id}', ${r}, ${b.perRoom})">ì´ ${roomTotal}ë‘</button>`;
                grid.appendChild(header);
                for (let c = 1; c <= b.perRoom; c++) createCell(grid, `${id}_${r}_${c}`, b.isGrower ? `${(c*2)-1}-${c*2}ë²ˆ` : `${c}ë²ˆ`, b.vaccineDay, b.cycle, b.isGrower);
            }
        } else {
            grid.style.gridTemplateColumns = b.layout === 'lr' ? 'repeat(2, 1fr)' : 'repeat(auto-fill, minmax(85px, 1fr))';
            for (let i = 1; i <= b.count; i++) createCell(grid, `${id}_${i}`, b.layout === 'lr' ? (i%2==1?'ì¢Œ':'ìš°')+Math.ceil(i/2) : i+'ë²ˆ', b.vaccineDay, b.cycle);
        }
        document.getElementById('detail-view').style.display = 'block';
    }

    // ì„ì‹ ì‚¬ ì „ìš© ê·¸ë£¹ í¸ì§‘ ëª¨ë‹¬
    function openGestModal(id, rowNum, gIdx) {
        const groups = JSON.parse(localStorage.getItem(`${id}_row${rowNum}_groups`) || "[]");
        const g = groups[gIdx];
        document.getElementById('modal-title').innerText = `${rowNum}ì—´ ${g.start}~${g.end}ë²ˆ ê·¸ë£¹`;
        document.getElementById('modal-sub-info').innerHTML = `ë§ˆë¦¿ìˆ˜: <b>${g.count || 0}ë‘</b><br>êµë°°ì¼: ${g.date}<br>ê·¸ë£¹ëª…: ${g.name}`;
        
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn" style="background:var(--blue); grid-column: span 2;" onclick="editGestGroup('${id}', ${rowNum}, ${gIdx})">ğŸ“ ì •ë³´ ìˆ˜ì •</button>
            <button class="btn" style="background:var(--red); grid-column: span 2;" onclick="deleteGestGroup('${id}', ${rowNum}, ${gIdx})">ğŸ—‘ï¸ ê·¸ë£¹ ì‚­ì œ</button>
            <button class="btn" style="background:#888; grid-column: span 2;" onclick="closeModal()">ë‹«ê¸°</button>
        `;
        document.getElementById('action-modal').style.display = 'block';
    }

    function editGestGroup(id, rowNum, gIdx) {
        const groups = JSON.parse(localStorage.getItem(`${id}_row${rowNum}_groups`) || "[]");
        const g = groups[gIdx];
        const newCount = prompt("ì´ ëª‡ ë§ˆë¦¬ì…ë‹ˆê¹Œ?", g.count || 0);
        if (newCount === null) return;
        const newDate = prompt("êµë°°ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD)", g.date);
        if (newDate === null) return;
        
        g.count = parseInt(newCount);
        g.date = newDate;
        g.name = getGroupName(newDate);
        
        localStorage.setItem(`${id}_row${rowNum}_groups`, JSON.stringify(groups));
        closeModal(); openBuilding(id); initMap();
    }

    function deleteGestGroup(id, rowNum, gIdx) {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const groups = JSON.parse(localStorage.getItem(`${id}_row${rowNum}_groups`) || "[]");
            groups.splice(gIdx, 1);
            localStorage.setItem(`${id}_row${rowNum}_groups`, JSON.stringify(groups));
            closeModal(); openBuilding(id); initMap();
        }
    }

    function setStallRange(id, rowNum, max) {
        const start = prompt(`${rowNum}ì—´: ì‹œì‘ ìŠ¤í†¨ ë²ˆí˜¸`);
        if (!start) return;
        const end = prompt(`${rowNum}ì—´: ë ìŠ¤í†¨ ë²ˆí˜¸`);
        if (!end) return;
        const count = prompt(`í•´ë‹¹ ë²”ìœ„ ì´ ëª‡ ë§ˆë¦¬ì…ë‹ˆê¹Œ?`);
        if (!count) return;
        const date = prompt(`êµë°°ì¼ ì…ë ¥ (YYYY-MM-DD)`, today.toISOString().split('T')[0]);
        if (date) {
            const rangeKey = `${id}_row${rowNum}_groups`;
            let groups = JSON.parse(localStorage.getItem(rangeKey) || "[]");
            groups.push({ start: parseInt(start), end: parseInt(end), count: parseInt(count), date: date, name: getGroupName(date) });
            localStorage.setItem(rangeKey, JSON.stringify(groups));
            openBuilding(id);
            initMap();
        }
    }

    // ì¼ë°˜ì‚¬ ëª¨ë‹¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function openModal(key, label, count, inDateStr) {
        currentSelectedKey = key;
        const b = buildings[key.split('_')[0]];
        document.getElementById('modal-title').innerText = label + " ê´€ë¦¬";
        let info = `í˜„ì¬ ë§ˆë¦¿ìˆ˜: <b>${count}ë‘</b>`;
        if (inDateStr) {
            const inDate = new Date(inDateStr);
            const moveDate = new Date(inDate); moveDate.setDate(inDate.getDate() + (b.cycle || 0));
            info += `<br>ì…ì‹ì¼: ${inDateStr}<br><b>ì˜ˆì •ì¼: ${moveDate.toLocaleDateString()}</b>`;
        }
        document.getElementById('modal-sub-info').innerHTML = info;
        
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn" style="background:var(--blue); grid-column: span 2;" onclick="manualEdit()">âŒ¨ï¸ ë§ˆë¦¿ìˆ˜ ì§ì ‘ ì…ë ¥</button>
            <button class="btn" style="background:var(--green);" onclick="adjustCount(1)">+1 ì…ì‹</button>
            <button class="btn" style="background:var(--red);" onclick="adjustCount(-1)">-1 íì‚¬</button>
            <button class="btn" style="background:var(--work); grid-column: span 2;" onclick="setInDate()">ğŸ“… ë‚ ì§œ ì„¤ì •</button>
            <button class="btn" style="background:#888; grid-column: span 2;" onclick="closeModal()">ë‹«ê¸°</button>
        `;
        document.getElementById('action-modal').style.display = 'block';
    }

    function createCell(parent, key, label, vDay, cycle, isGrower = false) {
        const val = parseInt(localStorage.getItem(key)) || 0;
        const inDateStr = localStorage.getItem(key + '_date');
        const div = document.createElement('div');
        div.className = 'cell ' + (val == 0 ? '' : 'active');
        if (inDateStr && val > 0) {
            let vaccineName = "ğŸ’‰ë°±ì‹ "; let hasVaccine = false;
            if (isGrower) {
                if (checkWorkThisWeek(inDateStr, 7)) { hasVaccine = true; vaccineName = "ğŸ’‰í‰ë§‰"; }
                else if (checkWorkThisWeek(inDateStr, cycle - 7)) { hasVaccine = true; vaccineName = "ğŸ’‰êµ¬ì œì—­"; }
            }
            if (hasVaccine) { div.classList.add('vaccine-alert'); div.setAttribute('data-vaccine', vaccineName); }
            const target = new Date(inDateStr); target.setDate(target.getDate() + (cycle || 0));
            div.innerHTML = `<span>${label}</span><b>${val}</b><div class="date-info">ì˜ˆì •:${target.getMonth()+1}/${target.getDate()}</div>`;
        } else { div.innerHTML = `<span>${label}</span><b>${val}</b>`; }
        div.onclick = () => openModal(key, label, val, inDateStr);
        parent.appendChild(div);
    }

    // ë‚˜ë¨¸ì§€ ê³µí†µ í•¨ìˆ˜ë“¤ (ìˆ˜ì • ì—†ìŒ)
    function editGiltGroup(id) {
        const currentCount = localStorage.getItem(`${id}_group_count`) || 0;
        const currentDate = localStorage.getItem(`${id}_group_date`) || today.toISOString().split('T')[0];
        const currentVaccine = localStorage.getItem(`${id}_group_vaccine`) || '';
        const newDate = prompt("ì…ì‹ì¼ì (YYYY-MM-DD):", currentDate); if (newDate === null) return;
        const newCount = prompt("êµ°ì‚¬ì¹¸ ë§ˆë¦¿ìˆ˜:", currentCount); if (newCount === null) return;
        const newVaccine = prompt("ë°±ì‹ ì¢…ë¥˜:", currentVaccine); if (newVaccine === null) return;
        localStorage.setItem(`${id}_group_count`, parseInt(newCount) || 0);
        localStorage.setItem(`${id}_group_date`, newDate);
        localStorage.setItem(`${id}_group_vaccine`, newVaccine);
        openBuilding(id); initMap();
    }
    function batchSetRoom(id, r, per) {
        const total = prompt(`${r}ë²ˆ ë°© ì „ì²´ ë§ˆë¦¿ìˆ˜:`);
        const d = prompt(`ì…ì‹ ë‚ ì§œ:`, today.toISOString().split('T')[0]);
        if(total !== null) {
            const each = Math.floor(parseInt(total)/per), rem = parseInt(total)%per;
            for(let c=1; c<=per; c++) {
                localStorage.setItem(`${id}_${r}_${c}`, each + (c===1?rem:0));
                if(d) localStorage.setItem(`${id}_${r}_${c}_date`, d);
            }
            refreshUI();
        }
    }
    function manualEdit() { 
        const n = prompt("ë§ˆë¦¿ìˆ˜ ì§ì ‘ ì…ë ¥:", localStorage.getItem(currentSelectedKey) || 0);
        if (n !== null) { localStorage.setItem(currentSelectedKey, parseInt(n)); refreshUI(); }
    }
    function adjustCount(amt) {
        let cnt = parseInt(localStorage.getItem(currentSelectedKey)) || 0;
        localStorage.setItem(currentSelectedKey, Math.max(0, cnt + amt));
        refreshUI();
    }
    function setInDate() {
        const d = prompt("ë‚ ì§œ ì…ë ¥ (YYYY-MM-DD):", today.toISOString().split('T')[0]);
        if (d) { localStorage.setItem(currentSelectedKey + '_date', d); refreshUI(); }
    }
    function refreshUI() { openBuilding(currentSelectedKey.split('_')[0]); closeModal(); initMap(); }
    function closeModal() { document.getElementById('action-modal').style.display = 'none'; }
    function closeBuilding() { document.getElementById('detail-view').style.display = 'none'; initMap(); }

    initMap();
</script>
</body>
</html>
