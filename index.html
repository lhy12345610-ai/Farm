<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë†ì¥ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        :root { --main-bg: #f0f2f5; --card-bg: #ffffff; --primary: #1976d2; --accent: #673ab7; --green: #2e7d32; --red: #c62828; --orange: #ff9800; }
        body { font-family: -apple-system, sans-serif; background: var(--main-bg); margin: 0; padding: 15px; padding-bottom: 50px; color: #333; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header { text-align: center; padding: 10px 0 20px; }
        .header h1 { font-size: 1.3rem; margin: 0; color: #1a1a1a; }
        .total-summary { background: white; padding: 10px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ë©”ì¸ ì§€ë„(ì¡°ê°ë„) */
        .farm-map { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .map-building { 
            background: var(--card-bg); border: 2px solid #ddd; border-radius: 12px; padding: 15px 5px;
            text-align: center; cursor: pointer; position: relative; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .map-building:active { transform: scale(0.95); }
        .work-badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid white; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .map-building b { font-size: 0.85rem; display: block; margin-bottom: 5px; }
        .map-building span { font-size: 0.9rem; color: var(--green); font-weight: bold; }

        /* ìƒì„¸ í™”ë©´ */
        #detail-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main-bg); z-index: 100; overflow-y: auto; }
        .nav-bar { background: #333; color: white; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 10; }
        .close-btn { background: none; border: 1px solid white; color: white; padding: 5px 15px; border-radius: 5px; margin-right: 15px; }
        
        .content-container { padding: 15px; }
        .grid-container { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }

        /* ë°© ì œëª© ë° ì´í•© ì…ë ¥ ë ˆì´ì•„ì›ƒ */
        .room-header { 
            grid-column: 1 / -1; background: #e9ecef; padding: 12px; border-radius: 10px; 
            display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-left: 6px solid #adb5bd;
        }
        .room-header.active-work { border-left-color: var(--accent); background: #f3e5f5; }
        .room-title { font-weight: bold; font-size: 0.95rem; }
        .room-total-btn { background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; }

        /* ê°œë³„ ì¹¸ ìŠ¤íƒ€ì¼ */
        .cell { 
            background: white; border: 1px solid #eee; border-radius: 10px; aspect-ratio: 1/1.1;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .cell.has-pigs { border-color: #a5d6a7; background: #f1f8e9; }
        .cell.work-target { border: 2px solid var(--accent); background: #f3e5f5; }
        .cell b { font-size: 1.2rem; margin: 2px 0; }
        .cell span { font-size: 0.7rem; color: #777; }
        .date-info { font-size: 0.6rem; color: #555; text-align: center; }
        .vaccine-tag { position: absolute; top: -5px; right: -5px; background: var(--orange); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; font-weight: bold; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; }
        #action-modal { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 25px 20px; box-sizing: border-box; }
        .btn-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .full-btn { grid-column: span 2; }
        .btn { padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; color: white; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ· ìŠ¤ë§ˆíŠ¸ ë†ì¥ ê´€ë¦¬</h1>
</div>

<div class="total-summary" id="main-summary">ì „ì²´ ë¼ì§€: ê³„ì‚° ì¤‘...</div>

<div class="farm-map" id="top-line"></div>
<div class="farm-map" id="bottom-line" style="grid-template-columns: repeat(2, 1fr);"></div>

<div id="detail-view">
    <div class="nav-bar">
        <button class="close-btn" onclick="closeBuilding()">ë‹«ê¸°</button>
        <span id="detail-title">ëˆì‚¬ ìƒì„¸</span>
    </div>
    <div class="content-container" id="detail-grid" class="grid-container"></div>
</div>

<div id="modal-overlay" onclick="closeModal()">
    <div id="action-modal" onclick="event.stopPropagation()">
        <h3 id="modal-label" style="margin: 0 0 15px;">ì¹¸ ê´€ë¦¬</h3>
        <div id="modal-info" style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px; font-size:0.9rem; line-height:1.5;"></div>
        <div class="btn-group">
            <button class="btn full-btn" style="background:var(--primary);" onclick="promptCount()">âŒ¨ï¸ ë§ˆë¦¿ìˆ˜ ì§ì ‘ ì…ë ¥</button>
            <button class="btn" style="background:var(--green);" onclick="changeCount(1)">+1 ì…ì‹</button>
            <button class="btn" style="background:var(--red);" onclick="changeCount(-1)">-1 íì‚¬</button>
            <button class="btn full-btn" style="background:var(--accent);" onclick="promptDate()">ğŸ“… ë‚ ì§œ ì„¤ì • (ì…ì‹/ì´ìœ )</button>
            <button class="btn full-btn" style="background:#888;" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    const buildings = {
        'farrow1': { title: 'ë¶„ë§Œ 1ë™', count: 8, line: 'top', cycle: 28, workName: 'ê¸ˆìš”ì´ìœ ' },
        'farrow2': { title: 'ë¶„ë§Œ 2,3ë™', count: 12, line: 'top', cycle: 28, workName: 'ê¸ˆìš”ì´ìœ ' },
        'nursery': { title: 'ìëˆì‚¬', rooms: 5, perRoom: 4, line: 'top', layout: 'room', cycle: 33, workName: 'í™”/ìˆ˜ì „ì¶œ', vaccineDay: 23 },
        'grower': { title: 'ìœ¡ì„±ì‚¬', rooms: 6, perRoom: 3, line: 'top', layout: 'room', cycle: 28, workName: 'í™”/ìˆ˜ì „ì¶œ', isGrower: true },
        'gilt': { title: 'í›„ë³´ì‚¬', count: 10, line: 'top' },
        'mating': { title: 'ì¢…ë¶€ì‚¬', count: 10, line: 'top' },
        'finisher1': { title: 'ë¹„ìœ¡ 1ë™', count: 12, line: 'bottom', layout: 'lr' },
        'finisher2': { title: 'ë¹„ìœ¡ 2ë™', count: 22, line: 'bottom', layout: 'lr' },
        'finisher3': { title: 'ë¹„ìœ¡ 3ë™', count: 21, line: 'bottom' },
        'gest4': { title: 'ì„ì‹  4ë™', count: 20, line: 'bottom' },
        'gest5': { title: 'ì„ì‹  5ë™', count: 20, line: 'bottom' }
    };

    let selectedKey = '';
    const today = new Date();
    const mon = new Date(today); mon.setDate(today.getDate() - (today.getDay() || 7) + 1); mon.setHours(0,0,0,0);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);

    function isThisWeek(dateStr, daysToAdd) {
        if (!dateStr) return false;
        const d = new Date(dateStr); d.setDate(d.getDate() + daysToAdd);
        return d >= mon && d <= sun;
    }

    function updateMain() {
        const top = document.getElementById('top-line');
        const bot = document.getElementById('bottom-line');
        top.innerHTML = ''; bot.innerHTML = '';
        let farmTotal = 0;

        for (let id in buildings) {
            const b = buildings[id];
            let bTotal = 0; let hasWork = false;
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith(id) && !k.includes('_date')) {
                    const c = parseInt(localStorage.getItem(k)) || 0;
                    bTotal += c; farmTotal += c;
                    const d = localStorage.getItem(k + '_date');
                    if (c > 0 && ((b.cycle && isThisWeek(d, b.cycle)) || (b.vaccineDay && isThisWeek(d, b.vaccineDay)))) hasWork = true;
                }
            }
            const div = document.createElement('div');
            div.className = 'map-building';
            div.onclick = () => openBuilding(id);
            div.innerHTML = `${hasWork ? '<div class="work-badge">!</div>' : ''}<b>${b.title}</b><span>${bTotal}ë‘</span>`;
            (b.line === 'top' ? top : bot).appendChild(div);
        }
        document.getElementById('main-summary').innerText = `ë†ì¥ ì „ì²´ ë¼ì§€: ${farmTotal}ë‘`;
    }

    function openBuilding(id) {
        const b = buildings[id];
        const grid = document.getElementById('detail-grid');
        document.getElementById('detail-title').innerText = b.title;
        grid.innerHTML = '';
        grid.className = 'grid-container';

        if (b.layout === 'room') {
            for (let r = 1; r <= b.rooms; r++) {
                let rTotal = 0; let rDates = []; let rWork = '';
                for (let c = 1; c <= b.perRoom; c++) {
                    const k = `${id}_${r}_${c}`;
                    const count = parseInt(localStorage.getItem(k)) || 0;
                    const d = localStorage.getItem(k + '_date');
                    rTotal += count; if(d) rDates.push(d);
                    if (count > 0 && isThisWeek(d, b.cycle)) rWork = b.workName;
                    if (count > 0 && b.vaccineDay && isThisWeek(d, b.vaccineDay)) rWork = 'ë°±ì‹ ';
                }
                const head = document.createElement('div');
                head.className = 'room-header' + (rWork ? ' active-work' : '');
                head.innerHTML = `
                    <div class="room-title-area">
                        <div class="room-title">${r}ë²ˆ ë°© ${rWork ? `<span style="color:var(--accent)">[${rWork}]</span>` : ''}</div>
                        <div style="font-size:0.65rem; color:#666;">ì…ì‹: ${[...new Set(rDates)].join(', ') || 'ë‚ ì§œì—†ìŒ'}</div>
                    </div>
                    <button class="room-total-btn" onclick="batchRoom('${id}',${r},${b.perRoom})">ë°© ì´í•©: ${rTotal}ë‘</button>
                `;
                grid.appendChild(head);
                for (let c = 1; c <= b.perRoom; c++) {
                    createCell(grid, `${id}_${r}_${c}`, b.isGrower ? `${(c*2)-1}-${c*2}ë²ˆ` : `${c}ë²ˆ`, b);
                }
            }
        } else {
            for (let i = 1; i <= b.count; i++) {
                createCell(grid, `${id}_${i}`, i + 'ë²ˆ', b);
            }
        }
        document.getElementById('detail-view').style.display = 'block';
    }

    function createCell(parent, key, label, b) {
        const count = parseInt(localStorage.getItem(key)) || 0;
        const date = localStorage.getItem(key + '_date');
        const div = document.createElement('div');
        div.className = 'cell' + (count > 0 ? ' has-pigs' : '');
        
        let subInfo = '';
        if (count > 0 && date) {
            if (b.vaccineDay && isThisWeek(date, b.vaccineDay)) div.innerHTML += '<div class="vaccine-tag">ğŸ’‰ë°±ì‹ </div>';
            if (b.cycle && isThisWeek(date, b.cycle)) div.classList.add('work-target');
            const target = new Date(date); target.setDate(target.getDate() + (b.cycle || 0));
            subInfo = `<div class="date-info">${target.getMonth()+1}/${target.getDate()} ì´ë™</div>`;
        }
        
        div.innerHTML += `<span>${label}</span><b>${count}</b>${subInfo}`;
        div.onclick = () => openModal(key, label, count, date, b);
        parent.appendChild(div);
    }

    function batchRoom(id, r, per) {
        const total = prompt(`${r}ë²ˆ ë°© ì „ì²´ ë§ˆë¦¿ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
        if (total === null) return;
        const date = prompt(`ë°© ì „ì²´ ì…ì‹/ì´ìœ  ë‚ ì§œ (YYYY-MM-DD):`, today.toISOString().split('T')[0]);
        const each = Math.floor(total / per);
        const rem = total % per;
        for (let c = 1; c <= per; c++) {
            localStorage.setItem(`${id}_${r}_${c}`, each + (c === 1 ? rem : 0));
            if (date) localStorage.setItem(`${id}_${r}_${c}_date`, date);
        }
        openBuilding(id); updateMain();
    }

    function openModal(key, label, count, date, b) {
        selectedKey = key;
        document.getElementById('modal-label').innerText = label + " ê´€ë¦¬";
        let info = `í˜„ì¬ ë§ˆë¦¿ìˆ˜: <b>${count}ë‘</b><br>ì…ì‹/ì´ìœ  ë‚ ì§œ: ${date || 'ë¯¸ë“±ë¡'}`;
        if (date && b.cycle) {
            const d = new Date(date); d.setDate(d.getDate() + b.cycle);
            info += `<br><b>ë‹¤ìŒ ì´ë™ì˜ˆì •: ${d.toLocaleDateString()}</b>`;
        }
        document.getElementById('modal-info').innerHTML = info;
        document.getElementById('modal-overlay').style.display = 'block';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function closeBuilding() { document.getElementById('detail-view').style.display = 'none'; updateMain(); }

    function changeCount(n) {
        const cur = parseInt(localStorage.getItem(selectedKey)) || 0;
        localStorage.setItem(selectedKey, Math.max(0, cur + n));
        refreshAfterAction();
    }
    function promptCount() {
        const n = prompt("ì •í™•í•œ ë§ˆë¦¿ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (n !== null) { localStorage.setItem
